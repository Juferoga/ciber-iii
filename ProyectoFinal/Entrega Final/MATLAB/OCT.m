close all
clear all
warning('off')

% Sistema
a = newfis('Retinopatía diabética');

% Variable de entrada : Thickness
a = addvar(a, 'input', 'T', [0 2]);  % Rango de espesor

% Funciones de pertenencia
a = addmf(a, 'input', 1, 'cero', 'gaussmf', [0.5 0.1]);
a = addmf(a, 'input', 1, 'grande', 'trapmf', [1 1.3 1.7 2]);

% Variable de entrada : Cyst
a = addvar(a, 'input', 'Q', [0 3]);  % Quistes metarretineanos

% Funciones de pertenencia
a = addmf(a, 'input', 2, 'absent', 'trimf', [0 0.1 0.2]);
a = addmf(a, 'input', 2, 'mild', 'trapmf', [0.5 0.7 1 1.2]);
a = addmf(a, 'input', 2, 'moderate', 'gaussmf', [0.2 2]);
a = addmf(a, 'input', 2, 'severe', 'trimf', [2.5 2.8 3]);

% Variable de entrada : EZ
a = addvar(a, 'input', 'EZ', [0 2]);  % Elipsoides

% Funciones de pertenencia
a = addmf(a, 'input', 3, 'e_intact', 'trapmf', [0 0.1 0.3 0.4]);
a = addmf(a, 'input', 3, 'e_disrupted', 'trimf', [0.7 1 1.3]);
a = addmf(a, 'input', 3, 'e_absent', 'gaussmf', [0.2 2]);

% Variable de entrada : DRIL
a = addvar(a, 'input', 'DRIL', [0 2]);  % Desorganización de las capas de la retina

% Funciones de pertenencia
a = addmf(a, 'input', 4, 'without', 'trimf', [0 0.2 0.4]);
a = addmf(a, 'input', 4, 'with', 'gaussmf', [0.7 1.8]);

% Variable de salida : Retinopatía diabética
a=addvar(a,'output','nivel de retinopatia',[0 4]);

% Funciones de pertenencia
a=addmf(a,'output',1,'Temprana','trimf',[0 0.5 1]);
a=addmf(a,'output',1,'Avanzada','trimf',[1 1.5 2]);
a=addmf(a,'output',1,'Severa','trimf',[2 2.5 3]);
a=addmf(a,'output',1,'Atrófica','trimf',[3 3.5 4]);

% Reglas de inferencia
% [T Q E D] -> [nivel de retinopatia]
ruleList = [
    1 1 1 1 1 1 1  % Temprana
    1 2 1 1 2 1 1  % Avanzada
    2 2 1 2 3 1 1  % Severa
    2 3 2 2 4 1 1  % Atrófica
];

a = addRule(a,ruleList);

% Sistema difuso

fuzzy(a)

% Observaciones del nivel de retinopatía

% Datos de entrada
entradas = [
    1.0 3.0 3.0 1.0;
    0.0 1.0 0.0 0.0;
    3.0 1.0 3.0 2.0;
    1.0 1.0 1.0 1.0;
    2.0 2.0 2.0 1.0;
    1.0 1.0 1.0 0.0;
    0.0 0.0 3.0 3.0;
    2.0 3.0 2.0 2.0;
    2.0 3.0 3.0 1.0;
    1.0 3.0 3.0 1.0;
    0.0 1.0 1.0 0.0;
    2.0 2.0 2.0 0.0;
    1.0 2.0 2.0 2.0;
    3.0 1.0 3.0 3.0;
    1.0 2.0 2.0 2.0;
    2.0 2.0 2.0 2.0;
    2.0 2.0 1.0 1.0;
    2.0 2.0 2.0 2.0;
    2.0 2.0 1.0 2.0;
    2.0 3.0 1.0 2.0;
    0.0 0.0 2.0 3.0;
    1.0 1.0 0.0 1.0;
    0.0 0.0 0.0 3.0;
    0.0 0.0 0.0 0.0;
    0.0 3.0 3.0 3.0;
    1.0 0.0 0.0 0.0;
    1.0 2.0 3.0 2.0;
    1.0 0.0 0.0 1.0;
    2.0 0.0 3.0 3.0;
    2.0 1.0 1.0 2.0;
    2.0 3.0 3.0 0.0;
    1.0 3.0 2.0 3.0;
    0.0 1.0 0.0 0.0;
    1.0 1.0 1.0 1.0;
    2.0 2.0 1.0 3.0;
    3.0 1.0 1.0 2.0;
    0.0 0.0 0.0 0.0;
    1.0 1.0 3.0 3.0;
    2.0 2.0 2.0 1.0;
    1.0 1.0 2.0 2.0;
    2.0 2.0 3.0 2.0;
    1.0 3.0 2.0 1.0;
    0.0 0.0 1.0 0.0;
    0.0 0.0 3.0 3.0;
    2.0 1.0 1.0 2.0;
    0.0 0.0 1.0 1.0;
    3.0 3.0 2.0 0.0;
    0.0 2.0 0.0 2.0;
    2.0 3.0 2.0 3.0;
    0.0 0.0 1.0 0.0;
    1.0 2.0 2.0 2.0;
    1.0 1.0 1.0 3.0;
    2.0 1.0 2.0 2.0;
    2.0 3.0 3.0 3.0;
    3.0 0.0 3.0 2.0;
    0.0 2.0 2.0 2.0;
    3.0 1.0 1.0 3.0;
    2.0 1.0 1.0 2.0;
    3.0 3.0 2.0 3.0;
    3.0 3.0 1.0 1.0;
    3.0 2.0 0.0 3.0;
    0.0 0.0 2.0 3.0;
    2.0 2.0 3.0 3.0;
    2.0 0.0 0.0 2.0;
    1.0 1.0 1.0 0.0;
    1.0 0.0 0.0 0.0;
    0.0 0.0 1.0 1.0;
    2.0 1.0 3.0 1.0;
    2.0 2.0 3.0 2.0;
    0.0 0.0 0.0 1.0;
    2.0 2.0 2.0 2.0;
    1.0 1.0 1.0 1.0;
    1.0 2.0 2.0 2.0;
    3.0 3.0 0.0 0.0;
    3.0 3.0 2.0 3.0;
    2.0 2.0 2.0 2.0;
    0.0 1.0 1.0 0.0;
    2.0 1.0 2.0 1.0;
    3.0 0.0 0.0 0.0;
    3.0 3.0 0.0 0.0;
    2.0 0.0 2.0 0.0;
    1.0 2.0 1.0 1.0;
    0.0 0.0 2.0 0.0;
    3.0 1.0 3.0 1.0;
    1.0 0.0 0.0 1.0;
    2.0 1.0 2.0 3.0;
    2.0 1.0 2.0 2.0;
    2.0 3.0 2.0 3.0;
    1.0 1.0 2.0 2.0;
    1.0 2.0 1.0 1.0;
    2.0 3.0 1.0 2.0;
    2.0 3.0 2.0 1.0;
    0.0 2.0 3.0 0.0;
    0.0 0.0 2.0 2.0;
    3.0 3.0 3.0 2.0;
    2.0 1.0 1.0 2.0;
    1.0 2.0 3.0 2.0;
    1.0 1.0 1.0 1.0;
    1.0 1.0 1.0 0.0;
    1.0 2.0 1.0 1.0;
    0.0 0.0 3.0 2.0;
    1.0 1.0 1.0 0.0;
    3.0 1.0 2.0 2.0;
    1.0 1.0 2.0 1.0;
    2.0 3.0 2.0 1.0;
    1.0 2.0 1.0 1.0;
    1.0 0.0 0.0 1.0;
    1.0 1.0 2.0 2.0;
    2.0 2.0 1.0 2.0;
    0.0 0.0 1.0 0.0;
    3.0 1.0 2.0 1.0;
    3.0 2.0 3.0 1.0;
    1.0 1.0 2.0 2.0;
    0.0 0.0 1.0 1.0;
    2.0 1.0 2.0 2.0;
    2.0 2.0 1.0 1.0;
    0.0 2.0 2.0 0.0;
    2.0 2.0 2.0 1.0;
    2.0 3.0 2.0 2.0;
    2.0 1.0 1.0 1.0;
    3.0 2.0 0.0 3.0;
    2.0 3.0 0.0 0.0;
    0.0 0.0 0.0 1.0;
    1.0 1.0 2.0 3.0;
    0.0 0.0 3.0 2.0;
    1.0 1.0 2.0 1.0;
    1.0 2.0 1.0 2.0;
    2.0 2.0 2.0 1.0;
    0.0 1.0 1.0 0.0;
    1.0 1.0 1.0 2.0;
    0.0 0.0 0.0 0.0;
    2.0 0.0 0.0 3.0;
    0.0 1.0 1.0 1.0;
    0.0 1.0 1.0 0.0;
    2.0 1.0 2.0 1.0;
    1.0 3.0 1.0 3.0;
    1.0 0.0 0.0 1.0;
    0.0 2.0 0.0 3.0;
    1.0 1.0 1.0 3.0;
    0.0 3.0 2.0 3.0;
    3.0 2.0 3.0 0.0;
    0.0 1.0 0.0 1.0;
    1.0 1.0 3.0 1.0;
    1.0 1.0 2.0 2.0;
    2.0 3.0 2.0 1.0;
    3.0 1.0 3.0 3.0;
    1.0 2.0 1.0 2.0;
    2.0 1.0 1.0 2.0;
    2.0 1.0 2.0 1.0;
    1.0 2.0 2.0 1.0;
    0.0 1.0 0.0 1.0;
    0.0 0.0 2.0 0.0;
    3.0 1.0 1.0 2.0;
    3.0 3.0 0.0 2.0;
    3.0 2.0 2.0 3.0;
    2.0 3.0 1.0 1.0;
    2.0 2.0 2.0 2.0;
    0.0 3.0 0.0 3.0;
    0.0 0.0 1.0 1.0;
    0.0 1.0 0.0 0.0;
    0.0 2.0 0.0 2.0;
    2.0 1.0 2.0 1.0;
    0.0 0.0 1.0 1.0;
    0.0 1.0 0.0 1.0;
    3.0 1.0 2.0 3.0;
    0.0 1.0 0.0 0.0;
    0.0 1.0 1.0 0.0;
    3.0 0.0 3.0 2.0;
    2.0 0.0 2.0 2.0;
    2.0 2.0 0.0 0.0;
    3.0 2.0 3.0 0.0;
    0.0 0.0 1.0 0.0;
    0.0 0.0 2.0 3.0;
    1.0 1.0 0.0 1.0;
    0.0 0.0 1.0 1.0;
    2.0 2.0 3.0 0.0;
    0.0 1.0 0.0 1.0;
    1.0 1.0 0.0 0.0;
    1.0 2.0 3.0 1.0;
    1.0 1.0 1.0 1.0;
    1.0 0.0 0.0 0.0;
    0.0 1.0 0.0 1.0;
    0.0 0.0 3.0 0.0;
    1.0 1.0 1.0 1.0;
    0.0 1.0 1.0 0.0;
    0.0 1.0 0.0 1.0;
    0.0 0.0 0.0 1.0;
    1.0 1.0 2.0 2.0;
    2.0 1.0 2.0 1.0;
    2.0 2.0 2.0 2.0;
    3.0 2.0 1.0 2.0;
    0.0 2.0 2.0 3.0;
    0.0 1.0 0.0 0.0;
    3.0 1.0 1.0 2.0;
    1.0 1.0 1.0 2.0;
    2.0 2.0 2.0 2.0;
    2.0 1.0 1.0 1.0;
    2.0 1.0 2.0 1.0;
    3.0 2.0 3.0 2.0;
    1.0 1.0 1.0 2.0;
    0.0 2.0 0.0 0.0;
    2.0 1.0 2.0 1.0;
    1.0 1.0 2.0 1.0;
    3.0 1.0 3.0 3.0;
    3.0 3.0 2.0 0.0;
    3.0 3.0 1.0 2.0;
    1.0 0.0 0.0 0.0;
    1.0 1.0 1.0 0.0;
    1.0 2.0 1.0 1.0;
    1.0 1.0 1.0 1.0;
    1.0 1.0 0.0 0.0;
    1.0 0.0 0.0 0.0;
    1.0 2.0 2.0 1.0;
    1.0 1.0 2.0 1.0;
    0.0 3.0 0.0 3.0;
    3.0 2.0 2.0 2.0;
    3.0 2.0 2.0 0.0;
    2.0 1.0 2.0 1.0;
    3.0 3.0 3.0 2.0;
    3.0 1.0 2.0 2.0;
    1.0 1.0 1.0 2.0;
    0.0 0.0 1.0 1.0;
    1.0 1.0 3.0 2.0;
    2.0 2.0 1.0 1.0;
    1.0 0.0 1.0 1.0;
    1.0 1.0 2.0 3.0;
    3.0 2.0 2.0 3.0;
    0.0 3.0 2.0 0.0;
    1.0 1.0 1.0 1.0;
    1.0 2.0 1.0 1.0;
    1.0 1.0 1.0 1.0;
    1.0 2.0 2.0 1.0;
    2.0 3.0 2.0 2.0;
    1.0 2.0 1.0 1.0;
    3.0 3.0 3.0 1.0;
    3.0 2.0 2.0 3.0;
    3.0 2.0 2.0 0.0;
    2.0 2.0 1.0 2.0;
    1.0 0.0 0.0 1.0;
    1.0 1.0 2.0 1.0;
    2.0 2.0 2.0 1.0;
    0.0 0.0 3.0 0.0;
    2.0 2.0 2.0 1.0;
    1.0 1.0 2.0 1.0;
    3.0 1.0 2.0 2.0;
    2.0 0.0 3.0 2.0;
    2.0 0.0 2.0 0.0;
    1.0 1.0 1.0 1.0;
    3.0 2.0 3.0 3.0;
    1.0 1.0 1.0 2.0;
    2.0 2.0 0.0 3.0;
    1.0 1.0 0.0 0.0;
    1.0 1.0 1.0 1.0;
    0.0 3.0 0.0 0.0;
    2.0 2.0 1.0 1.0;
    0.0 0.0 0.0 1.0;
    2.0 2.0 1.0 1.0;
    1.0 2.0 2.0 2.0;
    2.0 3.0 1.0 2.0;
    0.0 0.0 0.0 0.0;
    0.0 0.0 0.0 0.0;
    2.0 1.0 2.0 2.0;
    3.0 3.0 2.0 2.0;
    3.0 3.0 2.0 3.0;
    1.0 1.0 2.0 3.0;
    1.0 2.0 1.0 1.0;
    0.0 0.0 0.0 0.0;
    2.0 2.0 2.0 2.0;
    0.0 1.0 0.0 1.0;
    1.0 1.0 1.0 2.0;
    1.0 1.0 1.0 0.0;
    1.0 0.0 0.0 0.0;
    0.0 2.0 3.0 3.0;
    3.0 2.0 3.0 3.0;
    1.0 0.0 1.0 1.0;
    2.0 2.0 3.0 3.0;
    2.0 1.0 2.0 2.0;
    1.0 1.0 1.0 0.0;
    0.0 1.0 1.0 0.0;
    0.0 0.0 3.0 2.0;
    1.0 0.0 1.0 0.0;
    1.0 1.0 2.0 2.0;
    1.0 0.0 0.0 0.0;
    1.0 1.0 2.0 2.0;
    2.0 3.0 0.0 0.0;
    2.0 3.0 3.0 3.0;
    0.0 0.0 0.0 0.0;
    2.0 1.0 1.0 2.0;
    0.0 0.0 1.0 0.0;
    1.0 2.0 2.0 1.0;
    1.0 2.0 1.0 1.0;
    3.0 3.0 3.0 3.0;
    2.0 1.0 1.0 2.0;
    1.0 2.0 1.0 1.0;
    0.0 0.0 1.0 1.0;
    2.0 0.0 0.0 3.0;
    1.0 0.0 0.0 1.0;
    2.0 2.0 1.0 1.0;
    0.0 3.0 0.0 0.0;
    1.0 1.0 1.0 2.0;
];
% Observaciones del nivel de retinopatía
observaciones = [
    3.0;
    1.0;
    3.0;
    1.0;
    2.0;
    1.0;
    4.0;
    3.0;
    3.0;
    3.0;
    1.0;
    4.0;
    2.0;
    3.0;
    2.0;
    4.0;
    2.0;
    2.0;
    2.0;
    3.0;
    4.0;
    1.0;
    4.0;
    1.0;
    4.0;
    1.0;
    3.0;
    1.0;
    4.0;
    2.0;
    4.0;
    3.0;
    1.0;
    2.0;
    3.0;
    3.0;
    1.0;
    3.0;
    3.0;
    2.0;
    4.0;
    3.0;
    1.0;
    4.0;
    2.0;
    1.0;
    4.0;
    4.0;
    4.0;
    1.0;
    3.0;
    3.0;
    2.0;
    4.0;
    4.0;
    4.0;
    3.0;
    2.0;
    4.0;
    3.0;
    4.0;
    4.0;
    3.0;
    4.0;
    1.0;
    1.0;
    1.0;
    3.0;
    4.0;
    1.0;
    4.0;
    3.0;
    2.0;
    4.0;
    4.0;
    2.0;
    1.0;
    3.0;
    4.0;
    4.0;
    4.0;
    2.0;
    4.0;
    3.0;
    1.0;
    3.0;
    2.0;
    4.0;
    2.0;
    2.0;
    3.0;
    3.0;
    4.0;
    4.0;
    4.0;
    2.0;
    3.0;
    1.0;
    1.0;
    2.0;
    4.0;
    1.0;
    3.0;
    2.0;
    3.0;
    2.0;
    1.0;
    2.0;
    2.0;
    1.0;
    3.0;
    3.0;
    2.0;
    1.0;
    2.0;
    2.0;
    4.0;
    3.0;
    4.0;
    3.0;
    4.0;
    4.0;
    1.0;
    3.0;
    4.0;
    2.0;
    3.0;
    2.0;
    1.0;
    2.0;
    4.0;
    4.0;
    1.0;
    1.0;
    2.0;
    3.0;
    1.0;
    4.0;
    3.0;
    4.0;
    4.0;
    1.0;
    3.0;
    3.0;
    3.0;
    3.0;
    2.0;
    2.0;
    3.0;
    2.0;
    1.0;
    4.0;
    3.0;
    4.0;
    3.0;
    3.0;
    2.0;
    4.0;
    1.0;
    1.0;
    4.0;
    2.0;
    1.0;
    1.0;
    3.0;
    1.0;
    1.0;
    4.0;
    4.0;
    4.0;
    4.0;
    1.0;
    4.0;
    1.0;
    1.0;
    4.0;
    1.0;
    1.0;
    3.0;
    2.0;
    1.0;
    1.0;
    4.0;
    2.0;
    1.0;
    1.0;
    1.0;
    2.0;
    2.0;
    2.0;
    3.0;
    4.0;
    1.0;
    3.0;
    2.0;
    4.0;
    2.0;
    3.0;
    4.0;
    3.0;
    4.0;
    2.0;
    2.0;
    3.0;
    4.0;
    3.0;
    1.0;
    1.0;
    2.0;
    1.0;
    1.0;
    1.0;
    2.0;
    3.0;
    4.0;
    3.0;
    4.0;
    2.0;
    3.0;
    3.0;
    2.0;
    1.0;
    3.0;
    2.0;
    1.0;
    3.0;
    4.0;
    4.0;
    1.0;
    2.0;
    2.0;
    2.0;
    4.0;
    2.0;
    3.0;
    4.0;
    4.0;
    2.0;
    1.0;
    2.0;
    2.0;
    4.0;
    2.0;
    2.0;
    3.0;
    4.0;
    4.0;
    3.0;
    3.0;
    2.0;
    4.0;
    1.0;
    1.0;
    4.0;
    2.0;
    1.0;
    2.0;
    2.0;
    3.0;
    1.0;
    1.0;
    2.0;
    3.0;
    3.0;
    3.0;
    3.0;
    1.0;
    2.0;
    1.0;
    2.0;
    1.0;
    1.0;
    4.0;
    3.0;
    1.0;
    4.0;
    2.0;
    1.0;
    1.0;
    4.0;
    1.0;
    2.0;
    1.0;
    2.0;
    4.0;
    3.0;
    1.0;
    2.0;
    1.0;
    2.0;
    2.0;
    4.0;
    2.0;
    2.0;
    1.0;
    4.0;
    1.0;
    2.0;
    4.0;
    2.0;
];

% Evaluar el sistema difuso para cada fila de entradas
predicciones = zeros(size(observaciones));
for i = 1:size(entradas, 1)
    predicciones(i) = evalfis(entradas(i, :), a);
end

figure;
scatter(1:size(observaciones, 1), observaciones, 'b', 'DisplayName', 'Observaciones');
hold on;
scatter(1:size(predicciones, 1), predicciones, 'r', 'DisplayName', 'Predicciones');
legend;
title('Predicciones vs Observaciones');
xlabel('Índice de la muestra');
ylabel('Valor');
hold off;

% Calcular el MSE
MSE = mean((observaciones - predicciones).^2);

figure;
bar(MSE);
title('Error Cuadrático Medio (MSE)');
xlabel('Índice de la muestra');
ylabel('MSE');


figure;
plot(MSE);
title('Error Cuadrático Medio (MSE)');
xlabel('Índice de la muestra');
ylabel('MSE');

